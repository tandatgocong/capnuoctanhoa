SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH , VITRIDHN, YEAR(kh.NGAYTHAY) AS NAM
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG
AND SUBSTRING(LOTRINH,3,2) IN ('01','02','03','04','05','06','07','08','09','10','11','12','13','14','15')
ORDER BY  LOTRINH ASC

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH , VITRIDHN, YEAR(kh.NGAYTHAY) AS NAM
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG
AND SUBSTRING(LOTRINH,3,2) IN ('16','17','18','19','20','21','22','23','24','25','26','27','28','29','30')
ORDER BY  LOTRINH ASC

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH , VITRIDHN, YEAR(kh.NGAYTHAY) AS NAM
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG
AND SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46')
AND YEAR(kh.NGAYTHAY)=2012 AND p.MAPHUONG = '02'
ORDER BY  LOTRINH ASC


SELECT LEFT(LOTRINH,2), LOTRINH, DANHBO, HOPDONG, HOTEN, SONHA, TENDUONG, PHUONG, QUAN,HIEUDH,CODH,SOTHANDH, VITRIDHN 
FROM TB_DULIEUKHACHHANG where SUBSTRING(LOTRINH,3,2) IN ('01','02','03','04','05','06','07','08','09','10','11','12','13','14','15')
ORDER BY  LOTRINH ASC

SELECT LEFT(LOTRINH,2), LOTRINH, DANHBO, HOPDONG, HOTEN, SONHA, TENDUONG, PHUONG, QUAN,HIEUDH,CODH,SOTHANDH, VITRIDHN 
FROM TB_DULIEUKHACHHANG where SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46')
ORDER BY  LOTRINH ASC

-----------------------------------------------
--SELECT LEFT(LOTRINH,2), LOTRINH, DANHBO, HOPDONG, HOTEN, SONHA, TENDUONG, PHUONG, QUAN,HIEUDH,CODH,SOTHANDH, VITRIDHN 
SELECT LEFT(LOTRINH,2), LOTRINH, DANHBO, HOPDONG, HOTEN, SONHA, TENDUONG, p.TENPHUONG,	q.TENQUAN,HIEUDH,CODH,SOTHANDH,YEAR(NGAYTHAY), VITRIDHN 
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG AND kh.QUAN='31' AND kh.PHUONG='06'
AND SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46')
ORDER BY  kh.LOTRINH ASC


SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS NAM, VITRIDHN
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG AND MAPHUONG='02'
AND SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46')
ORDER BY  kh.LOTRINH ASC


SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS NAM, VITRIDHN
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG AND  KY_<=4
AND SUBSTRING(LOTRINH,3,2) IN ('01','02','03','04','05','06','07','08','09','10','11','12','13','14','15')
ORDER BY  kh.LOTRINH ASC


SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS NAM, VITRIDHN
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG AND  KY_<=11
AND SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46')
ORDER BY  kh.LOTRINH ASC



------- lay so lieu 
drop table truysuat

SELECT LOTRINH,DANHBO, CASE WHEN MONTH(NGAYTHAY)<=5  THEN '0' ELSE MONTH(NGAYTHAY) END as 'KYTHAY', hd.TENDONGHO, CASE WHEN LEFT(kh.HIEUDH,3)='KEN'  THEN 'C' ELSE 'B' END as 'CAP', kh.CODH
INTO truysuat
FROM TB_DULIEUKHACHHANG kh, TB_HIEUDONGHO hd
WHERE MONTH(NGAYTHAY)<=8 AND YEAR(NGAYTHAY)=2012 AND DANHBO NOT IN (SELECT GANMOI_2012.DB FROM GANMOI_2012) AND LEFT(kh.HIEUDH,3) = hd.HIEUDH


select DANHBO, KYTHAY, TENDONGHO, CAP, CODH from truysuat  WHERE code=8
order by KYTHAY asc


SELECT * from  TB_DULIEUKHACHHANG 
WHERE DANHBO IN (SELECT DanhBo FROM HOADONTH01 where Code LIKE '8%')
  
  
UPDATE truysuat SET KYTHAY =8
FROM (SELECT * FROM HOADONTH08 where Field21 LIKE '8%'  ) as t2
WHERE  truysuat.DANHBO =  t2.DanhBo AND KYTHAY=0


insert into truysuat(LOTRINH, DANHBO, KYTHAY, TENDONGHO, CAP, CODH)
SELECT Khu as 'LOTRINH', HOADONTH01.DanhBo,'1',HIEU,CAP,CoDh 
FROM HOADONTH01 where Code LIKE '8%' AND NgayGan='2011'
AND DanhBo NOT IN (SELECT DANHBO FROM truysuat)
 
select KYTHAY,COUNT(*) from truysuat 
group by KYTHAY
order by KYTHAY asc


SELECT * fROM truysuat WHERE DANHBO IN (SELECT DANHBO FROM TB_GANMOI)

SELECT * fROM truysuat WHERE KYTHAY=2




UPDATE HOADONTH01 SET NgayGan = YEAR(t2.NGAYTHAY),HIEU=t2.TENDONGHO,CAP=CASE WHEN LEFT(t2.HIEUDH,3)='KEN'  THEN 'C' ELSE 'B' END, Khu=t2.LOTRINH


insert into DATKHUNG(DANHBO,KYTHAY)
SELECT DanhBo,'1'
FROM HOADONTH01
WHERE  code LIKE '8%'

SELECT LOTRINH,DANHBO, CASE WHEN MONTH(NGAYTHAY)<=5  THEN '0' ELSE MONTH(NGAYTHAY) END as 'KYTHAY', hd.TENDONGHO, CASE WHEN LEFT(kh.HIEUDH,3)='KEN'  THEN 'C' ELSE 'B' END as 'CAP', kh.CODH
INTO truysuat
FROM TB_DULIEUKHACHHANG kh, TB_HIEUDONGHO hd
WHERE MONTH(NGAYTHAY)<=8 AND YEAR(NGAYTHAY)=2012 AND DANHBO NOT IN (SELECT GANMOI_2012.DB FROM GANMOI_2012) AND LEFT(kh.HIEUDH,3) = hd.HIEUDH


select kh.DANHBO, MAX(dk.KYTHAY) as 'KYTHAY', hd.TENDONGHO, CASE WHEN LEFT(kh.HIEUDH,3)='KEN'  THEN 'C' ELSE 'B' END as 'CAP', kh.CODH
from DATKHUNG dk ,TB_DULIEUKHACHHANG kh, TB_HIEUDONGHO hd
where LEFT(kh.HIEUDH,3) = hd.HIEUDH and dk.DANHBO= kh.DANHBO
GROUP BY LOTRINH,kh.DANHBO, hd.TENDONGHO, CASE WHEN LEFT(kh.HIEUDH,3)='KEN'  THEN 'C' ELSE 'B' END, kh.CODH


SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG,'',kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q,HOADONTH12_2013 hd
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG
AND p.MAPHUONG = '05' AND p.MAQUAN='31' AND kh.DANHBO = hd.DANHBO
ORDER BY  LOTRINH ASC


SELECT * FROM HOADONTH06_2013 hd
WHERE  PHUONG = '11' AND QUAN='31'  AND hd.LNCC=0


-----------------------------

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH , VITRIDHN, YEAR(kh.NGAYTHAY) AS NAM
FROM  TB_DULIEUKHACHHANG kh,  PHUONG p, QUAN q
WHERE kh.QUAN = q.MAQUAN AND q.MAQUAN=p.MAQUAN AND kh.PHUONG=p.MAPHUONG
GROUP BY SUBSTRING(LOTRINH,1,2) ,kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,P.TENPHUONG, q.TENQUAN,kh.HIEUDH, kh.CODH,SOTHANDH , VITRIDHN, YEAR(kh.NGAYTHAY)
HAVING COUNT(HOPDONG)>1
ORDER BY  LOTRINH ASC

SELECT HOPDONG,COUNT(HOPDONG)
FROM  TB_DULIEUKHACHHANG kh
GROUP BY HOPDONG
HAVING COUNT(HOPDONG)>1


SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh
WHERE  YEAR(kh.NGAYTHAY)=2010 
 AND SUBSTRING(LOTRINH,3,2) IN ('01','02','03','04','05','06','07','08','09','10','11','12','13','14','15')
ORDER BY  LOTRINH ASC

-----------------------------------------------------
SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh
WHERE  YEAR(kh.NGAYTHAY)=2010 
 AND SUBSTRING(LOTRINH,3,2) IN ('01','02','03','04','05','06','07','08','09','10','11','12','13','14','15')
ORDER BY  LOTRINH ASC

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh
WHERE  YEAR(kh.NGAYTHAY)=2010 
   AND SUBSTRING(LOTRINH,3,2) IN ('16','17','18','19','20','21','22','23','24','25','26','27','28','29','30')
ORDER BY  LOTRINH ASC

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh
WHERE  YEAR(kh.NGAYTHAY)=2010 
  AND SUBSTRING(LOTRINH,3,2) IN ('31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50')
ORDER BY  LOTRINH ASC

SELECT SUBSTRING(LOTRINH,1,2) as 'DOT',kh.LOTRINH, kh.DANHBO, kh.HOPDONG, kh.HOTEN, kh.SONHA, kh.TENDUONG,kh.HIEUDH, kh.CODH,SOTHANDH, YEAR(kh.NGAYTHAY) AS 'NAM' , VITRIDHN
FROM  TB_DULIEUKHACHHANG kh
WHERE  YEAR(kh.NGAYTHAY)=2010 
 AND SUBSTRING(LOTRINH,3,2) IN ('51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','67','69','70')
ORDER BY  LOTRINH ASC



 

   
  